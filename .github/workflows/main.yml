# This workflow runs lint, build and test of the mono repo
name: Quality Gate

on:
  pull_request:
    branches: [main]

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  lint:
    name: Lint ğŸ“
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        run: |
          npm i -g pnpm@8.6.12
      - name: Install ğŸ“¦
        run: |
          pnpm install --frozen-lockfile
      - name: Nx Affected ğŸ‹
        uses: nrwl/nx-set-shas@177b48373c6dc583ce0d9257ffb484bdd232fedf # v3.0.2
      - name: Lint other files ğŸ“
        run: |
          pnpm exec nx affected:lint \
          --configuration=ci \
          --parallel=3
          pnpm lint-non-code-files

  build:
    name: Build ğŸ—ï¸
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        run: |
          npm i -g pnpm@8.6.12
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Nx Affected ğŸ‹
        uses: nrwl/nx-set-shas@177b48373c6dc583ce0d9257ffb484bdd232fedf # v3.0.2
      - name: Build ğŸ—ï¸
        run: |
          pnpm exec nx affected:build \
          --configuration=production \
          --parallel=3

  typechecking:
    name: Typechecking âœ”ï¸
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        run: |
          npm i -g pnpm@8.6.12
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Nx Affected ğŸ‹
        uses: nrwl/nx-set-shas@177b48373c6dc583ce0d9257ffb484bdd232fedf # v3.0.2
      - name: Typecheck âœ”ï¸
        run: |
          pnpm exec nx affected \
          --target typecheck \
          --parallel=3

  storybook:
    name: Storybook ğŸ“–
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: true
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 0
      - name: Setup pnpm âš™ï¸
        run: |
          npm i -g pnpm@8.6.12
      - name: Install ğŸ“¦
        run: |
          pnpm install
      - name: Nx Affected ğŸ‹
        uses: nrwl/nx-set-shas@177b48373c6dc583ce0d9257ffb484bdd232fedf # v3.0.2
      - name: Storybook Build ğŸ“–
        run: |
          pnpm exec nx affected \
          --target build-storybook \
          --parallel=3
